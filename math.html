<!doctype html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>数式描画ツール（LaTeX入力 & ボタン生成）</title>
  <style>
    :root{ --bg:#0b1020; --card:#121834; --muted:#9fb0ff; --text:#e9ecff; --btn:#1e2959; --btnh:#2a3879 }
    [data-theme="light"]{ --bg:#f6f8ff; --card:#ffffff; --muted:#5264b8; --text:#0f172a; --btn:#e7eeff; --btnh:#d9e4ff }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP"}
    .wrap{max-width:1000px;margin:40px auto;padding:0 16px}
    h1{font-size:clamp(20px,4vw,30px);margin:0 0 12px}
    .card{background:color-mix(in oklab, var(--card) 92%, transparent);border:1px solid color-mix(in oklab, var(--text) 12%, transparent);border-radius:14px;padding:18px;margin:14px 0}
    textarea{width:100%;min-height:140px;border-radius:10px;background:color-mix(in oklab, var(--bg) 92%, white 0%);color:var(--text);border:1px solid color-mix(in oklab, var(--text) 20%, transparent);padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;background:var(--btn);color:var(--text);font-size:14px;cursor:pointer}
    .btn:hover{background:var(--btnh)}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
    .toolbar .group{display:flex;flex-wrap:wrap;gap:6px}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:999px;border:1px solid color-mix(in oklab, var(--text) 18%, transparent);cursor:pointer;background:transparent}
    .tab.active{background:color-mix(in oklab, var(--text) 10%, transparent)}
    .muted{color:var(--muted);font-size:13px}
    .actionbar{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid color-mix(in oklab, var(--text) 18%, transparent);background:transparent}
    .kbd{display:inline-block;padding:1px 6px;border-radius:6px;border:1px solid color-mix(in oklab, var(--text) 25%, transparent);font-size:12px}
    .output{background:color-mix(in oklab, var(--bg) 92%, white 0%);padding:10px;border-radius:10px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hist{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid color-mix(in oklab, var(--text) 18%, transparent);padding:6px 8px;border-radius:999px;background:transparent;cursor:pointer}
    .chip:hover{background:color-mix(in oklab, var(--text) 10%, transparent)}
    .tooltip{position:relative}
    .tooltip:hover::after{content:attr(data-tip);position:absolute;left:50%;bottom:120%;transform:translateX(-50%);background:#000c;color:#fff;padding:4px 6px;border-radius:8px;white-space:nowrap;font-size:12px}
  </style>
  <script>
    // MathJax（SVG出力）
    window.MathJax = { tex:{inlineMath:[["$","$"],["\(","\)"]]}, svg:{fontCache:'local'} };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>数式描画ツール</h1>
      <div class="row">
        <button id="themeToggle" class="btn">🌗 テーマ</button>
        <a class="btn" href="index.html">← PDFツールへ</a>
      </div>
    </div>
    <p class="muted">ボタンを押すかテキストを入力 → 即時プレビュー。<span class="kbd">⌘/Ctrl</span>+<span class="kbd">Enter</span>で描画、<span class="kbd">⌘/Ctrl</span>+<span class="kbd">C</span>でコピー。</p>

    <div class="card">
      <div class="row">
        <label class="pill"><input type="checkbox" id="displayMode" checked style="accent-color:#6aa9ff"/> $$ ディスプレイ表示</label>
        <label class="pill"><input type="checkbox" id="autoRender" checked style="accent-color:#6aa9ff"/> 入力で自動描画</label>
      </div>

      <div class="tabbar" id="tabbar"></div>
      <div class="toolbar" id="toolbar"></div>

      <textarea id="input" placeholder="例：\int_0^1 x^2\,dx = 
\frac{a+b}{2} 
\sum_{n=1}^N n"></textarea>
      <div class="actionbar">
        <button id="render" class="btn">描画</button>
        <button id="copy" class="btn">TeXコピー</button>
        <button id="copyWrapped" class="btn tooltip" data-tip="$$...$$ で包んでコピー">$$ でコピー</button>
        <button id="saveSvg" class="btn">SVG保存</button>
        <button id="savePng" class="btn">PNG保存</button>
        <button id="shareUrl" class="btn">URL共有</button>
        <button id="clear" class="btn">クリア</button>
      </div>
      <p class="muted" style="margin-top:6px">ヒント：テキストを選択してから <b>分数/√/括弧</b> を押すと、選択を中に入れてくれます。</p>
    </div>

    <div class="card">
      <h3>プレビュー</h3>
      <div id="preview" class="output">（ここに数式が表示されます）</div>
    </div>

    <div class="card">
      <h3>コード出力</h3>
      <div id="output" class="output"></div>
    </div>

    <div class="card">
      <h3>最近の数式（ローカル保存）</h3>
      <div id="history" class="hist"></div>
    </div>
  </div>

  <script>
    // ====== ツールバー分類 ======
    const GROUPS = {
      '基本': [
        {l:'分数', i:'\frac{}{}'}, {l:'√', i:'\sqrt{}'},
        {l:'^ 上', i:'^{ }'}, {l:'_ 下', i:'_{ }'},
        {l:'( )', i:'\left(  \right)'}, {l:'[ ]', i:'\left[  \right]'}, {l:'{ }', i:'\left\{  \right\}'},
        {l:'| |', i:'\left|  \right|'}, {l:'〈〉', i:'\langle  \rangle'}
      ],
      '演算子': [
        {l:'∫', i:'\int'}, {l:'∑', i:'\sum'}, {l:'∏', i:'\prod'},
        {l:'lim', i:'\lim'}, {l:'→', i:'\rightarrow'}, {l:'⇒', i:'\Rightarrow'}, {l:'↦', i:'\mapsto'},
        {l:'≈', i:'\approx'}, {l:'≃', i:'\simeq'}, {l:'≡', i:'\equiv'}, {l:'≤', i:'\leq'}, {l:'≥', i:'\geq'}
      ],
      'ギリシャ': [
        {l:'α', i:'\alpha'}, {l:'β', i:'\beta'}, {l:'γ', i:'\gamma'}, {l:'δ', i:'\delta'}, {l:'ε', i:'\epsilon'},
        {l:'θ', i:'\theta'}, {l:'λ', i:'\lambda'}, {l:'μ', i:'\mu'}, {l:'ν', i:'\nu'}, {l:'ξ', i:'\xi'},
        {l:'π', i:'\pi'}, {l:'ρ', i:'\rho'}, {l:'σ', i:'\sigma'}, {l:'τ', i:'\tau'}, {l:'φ', i:'\phi'}, {l:'ω', i:'\omega'}
      ],
      '構造': [
        {l:'行列2x2', i:'\begin{bmatrix}  &  \  &  \end{bmatrix}'},
        {l:'行列3x3', i:'\begin{bmatrix}  &  &  \  &  &  \  &  &  \end{bmatrix}'},
        {l:'cases', i:'\begin{cases}  , & \\  , &  \end{cases}'},
        {l:'分数の和', i:'\frac{a}{b}+\frac{c}{d}'}, {l:'テイラー', i:'\sum_{n=0}^{\infty} \frac{f^{(n)}(a)}{n!}(x-a)^n'}
      ],
      'ベクトル': [
        {l:'∂', i:'\partial'}, {l:'∇', i:'\nabla'}, {l:'→ベクトル', i:'\vec{}'}, {l:'上線', i:'\overline{}'}, {l:'ハット', i:'\hat{}'}
      ]
    };

    const tabbar = document.getElementById('tabbar');
    const toolbar = document.getElementById('toolbar');
    const input = document.getElementById('input');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const displayMode = document.getElementById('displayMode');

    // タブ生成
    const tabs = Object.keys(GROUPS);
    let activeTab = tabs[0];
    function renderTabs(){
      tabbar.innerHTML='';
      tabs.forEach(t=>{
        const b=document.createElement('button'); b.className='tab'+(t===activeTab?' active':''); b.textContent=t; b.addEventListener('click',()=>{activeTab=t; renderToolbar(); renderTabs();}); tabbar.appendChild(b);
      });
    }
    function renderToolbar(){
      toolbar.innerHTML='';
      const g = GROUPS[activeTab];
      const box = document.createElement('div'); box.className='group';
      g.forEach(k=>{ const b=document.createElement('button'); b.className='btn tooltip'; b.textContent=k.l; b.dataset.insert=k.i; b.dataset.tip=k.i; box.appendChild(b); });
      toolbar.appendChild(box);
    }
    renderTabs(); renderToolbar();

    // ボタン挿入（選択を包む）
    toolbar.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.btn'); if(!btn) return;
      insertTemplate(btn.dataset.insert);
    });

    function insertTemplate(tpl){
      const s=input.selectionStart, e=input.selectionEnd; const sel=input.value.slice(s,e);
      let ins = tpl;
      const wrap = (pre,post)=> pre+(sel||' ')+post;
      if(tpl==='\frac{}{}') ins = `\frac{${sel||' '}}{ }`;
      else if(tpl==='\sqrt{}') ins = wrap('\sqrt{','}');
      else if(tpl==='^{ }') ins = `{${sel||''}}^{ }`;
      else if(tpl==='_{ }') ins = `{${sel||''}}_{ }`;
      else if(tpl==='\left(  \right)') ins = wrap('\left(','\right)');
      else if(tpl==='\left[  \right]') ins = wrap('\left[','\right]');
      else if(tpl==='\left\{  \right\}') ins = wrap('\left\{','\right\}');
      else if(tpl==='\left|  \right|') ins = wrap('\left|','\right|');
      else if(tpl==='\langle  \rangle') ins = wrap('\langle ',' \rangle');
      else if(tpl==='\int') ins = `\int_{ }^{ } ${sel||''}\,`;
      else if(/\(vec|overline|hat)\{\}/.test(tpl)) ins = tpl.replace('{}',`{${sel||' '}}`);
      input.value = input.value.slice(0,s)+ins+input.value.slice(e);
      const pos = s+ins.length; input.focus(); input.selectionStart=input.selectionEnd=pos;
      if(document.getElementById('autoRender').checked) render();
    }

    // レンダリング
    function render(){
      const code = input.value;
      const body = displayMode.checked ? `$$${code}$$` : `\(${code}\)`;
      preview.innerHTML = body;
      MathJax.typesetPromise([preview]);
      output.textContent = code;
      saveHistory(code);
    }
    document.getElementById('render').addEventListener('click', render);
    document.getElementById('autoRender').addEventListener('change', ()=>{ if(document.getElementById('autoRender').checked) render(); });
    input.addEventListener('input', ()=>{ if(document.getElementById('autoRender').checked) render(); });

    // コピー
    document.getElementById('copy').addEventListener('click',()=>{ navigator.clipboard.writeText(input.value).then(()=>toast('TeXをコピーしました')); });
    document.getElementById('copyWrapped').addEventListener('click',()=>{
      const code = displayMode.checked ? `$$${input.value}$$` : `\(${input.value}\)`;
      navigator.clipboard.writeText(code).then(()=>toast('包んだTeXをコピーしました')); 
    });

    // 画像保存
    async function currentSVG(){ await MathJax.typesetPromise([preview]); const svg=preview.querySelector('svg'); return svg? svg.outerHTML : null; }
    document.getElementById('saveSvg').addEventListener('click', async()=>{
      const svg=await currentSVG(); if(!svg) return; downloadBlob(new Blob([svg],{type:'image/svg+xml'}),'formula.svg');
    });
    document.getElementById('savePng').addEventListener('click', async()=>{
      const svg=await currentSVG(); if(!svg) return; const img=new Image(); const url=URL.createObjectURL(new Blob([svg],{type:'image/svg+xml'}));
      img.onload=()=>{ const scale=2; const c=document.createElement('canvas'); c.width=img.width*scale; c.height=img.height*scale; const ctx=c.getContext('2d'); ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0); c.toBlob(b=>{ if(b) downloadBlob(b,'formula.png'); URL.revokeObjectURL(url); },'image/png'); };
      img.src=url;
    });

    // URL共有（ハッシュ）
    function enc(s){return '#q='+encodeURIComponent(s)}
    function dec(){const m=location.hash.match(/^#q=(.*)$/);return m?decodeURIComponent(m[1]):''}
    document.getElementById('shareUrl').addEventListener('click',()=>{ const link=location.origin+location.pathname+enc(input.value); navigator.clipboard.writeText(link).then(()=>toast('共有URLをコピーしました')); history.replaceState(null,'',enc(input.value)); });
    const q=dec(); if(q){ input.value=q; render(); }

    // 履歴
    const KEY='math-history-v2'; const histEl=document.getElementById('history');
    function loadHist(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch{return[]} }
    function saveHistory(code){ if(!code||!code.trim()) return; const list=loadHist().filter(x=>x!==code); list.unshift(code); while(list.length>18) list.pop(); localStorage.setItem(KEY, JSON.stringify(list)); renderHist(); }
    function renderHist(){ const list=loadHist(); histEl.innerHTML=''; list.forEach(s=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=s.length>28? s.slice(0,28)+'…' : s; b.title=s; b.onclick=()=>{ input.value=s; render(); }; histEl.appendChild(b); }); }
    renderHist();

    // クリア
    document.getElementById('clear').addEventListener('click',()=>{ input.value=''; preview.textContent='（ここに数式が表示されます）'; output.textContent=''; toast('クリアしました'); });

    // テーマ
    const themeToggle=document.getElementById('themeToggle');
    function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
    const t0=localStorage.getItem('theme'); if(t0) setTheme(t0);
    themeToggle.addEventListener('click',()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; setTheme(cur==='dark'?'light':'dark'); });

    // util & ショートカット
    function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    function toast(msg){ const d=document.createElement('div'); d.textContent=msg; d.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#000b;color:#fff;padding:8px 12px;border-radius:10px;z-index:9999'; document.body.appendChild(d); setTimeout(()=>d.remove(),1400); }
    document.addEventListener('keydown',(ev)=>{ if((ev.metaKey||ev.ctrlKey)&&ev.key==='Enter'){ ev.preventDefault(); render(); } if((ev.metaKey||ev.ctrlKey)&&ev.key.toLowerCase()==='c'){ if(document.activeElement===input){ ev.preventDefault(); navigator.clipboard.writeText(input.value).then(()=>toast('TeXをコピーしました')); } } });
  </script>
</body>
</html>
<!doctype html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>数式描画ツール（LaTeX入力 & ボタン生成）</title>
  <style>
    :root{ --bg:#0b1020; --card:#121834; --muted:#9fb0ff; --text:#e9ecff; --btn:#1e2959; --btnh:#2a3879 }
    [data-theme="light"]{ --bg:#f6f8ff; --card:#ffffff; --muted:#5264b8; --text:#0f172a; --btn:#e7eeff; --btnh:#d9e4ff }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP"}
    .wrap{max-width:1000px;margin:40px auto;padding:0 16px}
    h1{font-size:clamp(20px,4vw,30px);margin:0 0 12px}
    .card{background:color-mix(in oklab, var(--card) 92%, transparent);border:1px solid color-mix(in oklab, var(--text) 12%, transparent);border-radius:14px;padding:18px;margin:14px 0}
    textarea{width:100%;min-height:140px;border-radius:10px;background:color-mix(in oklab, var(--bg) 92%, white 0%);color:var(--text);border:1px solid color-mix(in oklab, var(--text) 20%, transparent);padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;background:var(--btn);color:var(--text);font-size:14px;cursor:pointer}
    .btn:hover{background:var(--btnh)}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0}
    .toolbar .group{display:flex;flex-wrap:wrap;gap:6px}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:6px 10px;border-radius:999px;border:1px solid color-mix(in oklab, var(--text) 18%, transparent);cursor:pointer;background:transparent}
    .tab.active{background:color-mix(in oklab, var(--text) 10%, transparent)}
    .muted{color:var(--muted);font-size:13px}
    .actionbar{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid color-mix(in oklab, var(--text) 18%, transparent);background:transparent}
    .kbd{display:inline-block;padding:1px 6px;border-radius:6px;border:1px solid color-mix(in oklab, var(--text) 25%, transparent);font-size:12px}
    .output{background:color-mix(in oklab, var(--bg) 92%, white 0%);padding:10px;border-radius:10px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hist{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid color-mix(in oklab, var(--text) 18%, transparent);padding:6px 8px;border-radius:999px;background:transparent;cursor:pointer}
    .chip:hover{background:color-mix(in oklab, var(--text) 10%, transparent)}
    .tooltip{position:relative}
    .tooltip:hover::after{content:attr(data-tip);position:absolute;left:50%;bottom:120%;transform:translateX(-50%);background:#000c;color:#fff;padding:4px 6px;border-radius:8px;white-space:nowrap;font-size:12px}
  </style>
  <script>
    // MathJax（SVG出力）
    window.MathJax = { tex:{inlineMath:[["$","$"],["\(","\)"]]}, svg:{fontCache:'local'} };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>数式描画ツール</h1>
      <div class="row">
        <button id="themeToggle" class="btn">🌗 テーマ</button>
        <a class="btn" href="index.html">← PDFツールへ</a>
      </div>
    </div>
    <p class="muted">ボタンを押すかテキストを入力 → 即時プレビュー。<span class="kbd">⌘/Ctrl</span>+<span class="kbd">Enter</span>で描画、<span class="kbd">⌘/Ctrl</span>+<span class="kbd">C</span>でコピー。</p>

    <div class="card">
      <div class="row">
        <label class="pill"><input type="checkbox" id="displayMode" checked style="accent-color:#6aa9ff"/> $$ ディスプレイ表示</label>
        <label class="pill"><input type="checkbox" id="autoRender" checked style="accent-color:#6aa9ff"/> 入力で自動描画</label>
      </div>

      <div class="tabbar" id="tabbar"></div>
      <div class="toolbar" id="toolbar"></div>

      <textarea id="input" placeholder="例：\int_0^1 x^2\,dx = 
\frac{a+b}{2} 
\sum_{n=1}^N n"></textarea>
      <div class="actionbar">
        <button id="render" class="btn">描画</button>
        <button id="copy" class="btn">TeXコピー</button>
        <button id="copyWrapped" class="btn tooltip" data-tip="$$...$$ で包んでコピー">$$ でコピー</button>
        <button id="saveSvg" class="btn">SVG保存</button>
        <button id="savePng" class="btn">PNG保存</button>
        <button id="shareUrl" class="btn">URL共有</button>
        <button id="clear" class="btn">クリア</button>
      </div>
      <p class="muted" style="margin-top:6px">ヒント：テキストを選択してから <b>分数/√/括弧</b> を押すと、選択を中に入れてくれます。</p>
    </div>

    <div class="card">
      <h3>プレビュー</h3>
      <div id="preview" class="output">（ここに数式が表示されます）</div>
    </div>

    <div class="card">
      <h3>コード出力</h3>
      <div id="output" class="output"></div>
    </div>

    <div class="card">
      <h3>最近の数式（ローカル保存）</h3>
      <div id="history" class="hist"></div>
    </div>
  </div>

  <script>
    // ====== ツールバー分類 ======
    const GROUPS = {
      '基本': [
        {l:'分数', i:'\frac{}{}'}, {l:'√', i:'\sqrt{}'},
        {l:'^ 上', i:'^{ }'}, {l:'_ 下', i:'_{ }'},
        {l:'( )', i:'\left(  \right)'}, {l:'[ ]', i:'\left[  \right]'}, {l:'{ }', i:'\left\{  \right\}'},
        {l:'| |', i:'\left|  \right|'}, {l:'〈〉', i:'\langle  \rangle'}
      ],
      '演算子': [
        {l:'∫', i:'\int'}, {l:'∑', i:'\sum'}, {l:'∏', i:'\prod'},
        {l:'lim', i:'\lim'}, {l:'→', i:'\rightarrow'}, {l:'⇒', i:'\Rightarrow'}, {l:'↦', i:'\mapsto'},
        {l:'≈', i:'\approx'}, {l:'≃', i:'\simeq'}, {l:'≡', i:'\equiv'}, {l:'≤', i:'\leq'}, {l:'≥', i:'\geq'}
      ],
      'ギリシャ': [
        {l:'α', i:'\alpha'}, {l:'β', i:'\beta'}, {l:'γ', i:'\gamma'}, {l:'δ', i:'\delta'}, {l:'ε', i:'\epsilon'},
        {l:'θ', i:'\theta'}, {l:'λ', i:'\lambda'}, {l:'μ', i:'\mu'}, {l:'ν', i:'\nu'}, {l:'ξ', i:'\xi'},
        {l:'π', i:'\pi'}, {l:'ρ', i:'\rho'}, {l:'σ', i:'\sigma'}, {l:'τ', i:'\tau'}, {l:'φ', i:'\phi'}, {l:'ω', i:'\omega'}
      ],
      '構造': [
        {l:'行列2x2', i:'\begin{bmatrix}  &  \  &  \end{bmatrix}'},
        {l:'行列3x3', i:'\begin{bmatrix}  &  &  \  &  &  \  &  &  \end{bmatrix}'},
        {l:'cases', i:'\begin{cases}  , & \\  , &  \end{cases}'},
        {l:'分数の和', i:'\frac{a}{b}+\frac{c}{d}'}, {l:'テイラー', i:'\sum_{n=0}^{\infty} \frac{f^{(n)}(a)}{n!}(x-a)^n'}
      ],
      'ベクトル': [
        {l:'∂', i:'\partial'}, {l:'∇', i:'\nabla'}, {l:'→ベクトル', i:'\vec{}'}, {l:'上線', i:'\overline{}'}, {l:'ハット', i:'\hat{}'}
      ]
    };

    const tabbar = document.getElementById('tabbar');
    const toolbar = document.getElementById('toolbar');
    const input = document.getElementById('input');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const displayMode = document.getElementById('displayMode');

    // タブ生成
    const tabs = Object.keys(GROUPS);
    let activeTab = tabs[0];
    function renderTabs(){
      tabbar.innerHTML='';
      tabs.forEach(t=>{
        const b=document.createElement('button'); b.className='tab'+(t===activeTab?' active':''); b.textContent=t; b.addEventListener('click',()=>{activeTab=t; renderToolbar(); renderTabs();}); tabbar.appendChild(b);
      });
    }
    function renderToolbar(){
      toolbar.innerHTML='';
      const g = GROUPS[activeTab];
      const box = document.createElement('div'); box.className='group';
      g.forEach(k=>{ const b=document.createElement('button'); b.className='btn tooltip'; b.textContent=k.l; b.dataset.insert=k.i; b.dataset.tip=k.i; box.appendChild(b); });
      toolbar.appendChild(box);
    }
    renderTabs(); renderToolbar();

    // ボタン挿入（選択を包む）
    toolbar.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.btn'); if(!btn) return;
      insertTemplate(btn.dataset.insert);
    });

    function insertTemplate(tpl){
      const s=input.selectionStart, e=input.selectionEnd; const sel=input.value.slice(s,e);
      let ins = tpl;
      const wrap = (pre,post)=> pre+(sel||' ')+post;
      if(tpl==='\frac{}{}') ins = `\frac{${sel||' '}}{ }`;
      else if(tpl==='\sqrt{}') ins = wrap('\sqrt{','}');
      else if(tpl==='^{ }') ins = `{${sel||''}}^{ }`;
      else if(tpl==='_{ }') ins = `{${sel||''}}_{ }`;
      else if(tpl==='\left(  \right)') ins = wrap('\left(','\right)');
      else if(tpl==='\left[  \right]') ins = wrap('\left[','\right]');
      else if(tpl==='\left\{  \right\}') ins = wrap('\left\{','\right\}');
      else if(tpl==='\left|  \right|') ins = wrap('\left|','\right|');
      else if(tpl==='\langle  \rangle') ins = wrap('\langle ',' \rangle');
      else if(tpl==='\int') ins = `\int_{ }^{ } ${sel||''}\,`;
      else if(/\(vec|overline|hat)\{\}/.test(tpl)) ins = tpl.replace('{}',`{${sel||' '}}`);
      input.value = input.value.slice(0,s)+ins+input.value.slice(e);
      const pos = s+ins.length; input.focus(); input.selectionStart=input.selectionEnd=pos;
      if(document.getElementById('autoRender').checked) render();
    }

    // レンダリング
    function render(){
      const code = input.value;
      const body = displayMode.checked ? `$$${code}$$` : `\(${code}\)`;
      preview.innerHTML = body;
      MathJax.typesetPromise([preview]);
      output.textContent = code;
      saveHistory(code);
    }
    document.getElementById('render').addEventListener('click', render);
    document.getElementById('autoRender').addEventListener('change', ()=>{ if(document.getElementById('autoRender').checked) render(); });
    input.addEventListener('input', ()=>{ if(document.getElementById('autoRender').checked) render(); });

    // コピー
    document.getElementById('copy').addEventListener('click',()=>{ navigator.clipboard.writeText(input.value).then(()=>toast('TeXをコピーしました')); });
    document.getElementById('copyWrapped').addEventListener('click',()=>{
      const code = displayMode.checked ? `$$${input.value}$$` : `\(${input.value}\)`;
      navigator.clipboard.writeText(code).then(()=>toast('包んだTeXをコピーしました')); 
    });

    // 画像保存
    async function currentSVG(){ await MathJax.typesetPromise([preview]); const svg=preview.querySelector('svg'); return svg? svg.outerHTML : null; }
    document.getElementById('saveSvg').addEventListener('click', async()=>{
      const svg=await currentSVG(); if(!svg) return; downloadBlob(new Blob([svg],{type:'image/svg+xml'}),'formula.svg');
    });
    document.getElementById('savePng').addEventListener('click', async()=>{
      const svg=await currentSVG(); if(!svg) return; const img=new Image(); const url=URL.createObjectURL(new Blob([svg],{type:'image/svg+xml'}));
      img.onload=()=>{ const scale=2; const c=document.createElement('canvas'); c.width=img.width*scale; c.height=img.height*scale; const ctx=c.getContext('2d'); ctx.setTransform(scale,0,0,scale,0,0); ctx.drawImage(img,0,0); c.toBlob(b=>{ if(b) downloadBlob(b,'formula.png'); URL.revokeObjectURL(url); },'image/png'); };
      img.src=url;
    });

    // URL共有（ハッシュ）
    function enc(s){return '#q='+encodeURIComponent(s)}
    function dec(){const m=location.hash.match(/^#q=(.*)$/);return m?decodeURIComponent(m[1]):''}
    document.getElementById('shareUrl').addEventListener('click',()=>{ const link=location.origin+location.pathname+enc(input.value); navigator.clipboard.writeText(link).then(()=>toast('共有URLをコピーしました')); history.replaceState(null,'',enc(input.value)); });
    const q=dec(); if(q){ input.value=q; render(); }

    // 履歴
    const KEY='math-history-v2'; const histEl=document.getElementById('history');
    function loadHist(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch{return[]} }
    function saveHistory(code){ if(!code||!code.trim()) return; const list=loadHist().filter(x=>x!==code); list.unshift(code); while(list.length>18) list.pop(); localStorage.setItem(KEY, JSON.stringify(list)); renderHist(); }
    function renderHist(){ const list=loadHist(); histEl.innerHTML=''; list.forEach(s=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=s.length>28? s.slice(0,28)+'…' : s; b.title=s; b.onclick=()=>{ input.value=s; render(); }; histEl.appendChild(b); }); }
    renderHist();

    // クリア
    document.getElementById('clear').addEventListener('click',()=>{ input.value=''; preview.textContent='（ここに数式が表示されます）'; output.textContent=''; toast('クリアしました'); });

    // テーマ
    const themeToggle=document.getElementById('themeToggle');
    function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
    const t0=localStorage.getItem('theme'); if(t0) setTheme(t0);
    themeToggle.addEventListener('click',()=>{ const cur=document.documentElement.getAttribute('data-theme')||'dark'; setTheme(cur==='dark'?'light':'dark'); });

    // util & ショートカット
    function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    function toast(msg){ const d=document.createElement('div'); d.textContent=msg; d.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#000b;color:#fff;padding:8px 12px;border-radius:10px;z-index:9999'; document.body.appendChild(d); setTimeout(()=>d.remove(),1400); }
    document.addEventListener('keydown',(ev)=>{ if((ev.metaKey||ev.ctrlKey)&&ev.key==='Enter'){ ev.preventDefault(); render(); } if((ev.metaKey||ev.ctrlKey)&&ev.key.toLowerCase()==='c'){ if(document.activeElement===input){ ev.preventDefault(); navigator.clipboard.writeText(input.value).then(()=>toast('TeXをコピーしました')); } } });
  </script>
</body>
</html>
