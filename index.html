<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDFツールボックス（分割 / 結合 / 画像化 / CSVビューア）</title>
  <style>
    :root { --bg:#0b1020; --card:#121834; --muted:#9fb0ff; --accent:#6aa9ff; --text:#e9ecff; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1533 30%,#0b1020);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    h1{font-size:clamp(20px,4vw,30px);letter-spacing:.02em;margin:0 0 12px}
    p.lead{margin:0 0 24px;color:#c7d2fe}
    .card{background:rgba(18,24,52,.75);border:1px solid rgba(255,255,255,.08);backdrop-filter: blur(8px);border-radius:18px;padding:18px;margin:14px 0;box-shadow:0 10px 40px rgba(20,25,70,.35)}
    .muted{color:#9fb0ff;font-size:13px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:linear-gradient(135deg,#5a86ff,#7cc8ff);color:#03112a;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 0}
    .tab{padding:10px 14px;border-radius:999px;background:#0b122a;border:1px solid rgba(255,255,255,.12);cursor:pointer;font-weight:600}
    .tab.active{background:linear-gradient(135deg,#5a86ff33,#7cc8ff33);border-color:#6aa9ff}
    .panel{display:none}
    .panel.active{display:block}
    input[type="text"],input[type="number"],select{padding:10px 12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:#0b122a;color:var(--text);outline:none}
    input[type="file"]{width:100%;background:#0b122a;border-radius:12px;padding:10px;border:1px dashed rgba(255,255,255,.18)}
    label{font-size:13px;color:#c7d2fe;margin-right:6px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    progress{width:100%}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:6px 10px;background:#0b122a;border:1px solid rgba(255,255,255,.12);border-radius:999px;font-size:12px}
    table{border-collapse:collapse;width:100%;background:#0b122a}
    th,td{border:1px solid rgba(255,255,255,.12);padding:8px}
    th{cursor:pointer;background:#101a3a}
    canvas{max-width:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PDFツールボックス</h1>
    <p class="lead">ブラウザ内で完結するユーティリティ集：<b>分割</b> / <b>結合</b> / <b>画像として書き出し</b> / <b>CSVビューア&集計</b>。ファイルは外部送信されません。</p>

    <div class="tabs" id="tabs">
      <div class="tab active" data-target="#split">PDF分割</div>
      <div class="tab" data-target="#merge">PDF結合</div>
      <div class="tab" data-target="#exportImages">PDF→画像</div>
      <div class="tab" data-target="#csv">CSVビューア</div>
    </div>

    <!-- ===== PDF 分割（既存機能を移植） ===== -->
    <div id="split" class="panel active card">
      <div class="grid">
        <div>
          <label>PDFファイル</label>
          <input id="fileSplit" type="file" accept="application/pdf" />
          <div class="muted" id="infoSplit">PDF未選択</div>
        </div>
        <div>
          <label>モード</label>
          <select id="modeSplit">
            <option value="number">数字（…01, 02）</option>
            <option value="alpha">英字（A, B, …, AA）</option>
            <option value="custom">カスタム（末尾を賢く増分）</option>
          </select>
        </div>
        <div>
          <label>開始値</label>
          <input id="startSplit" type="text" placeholder="例: 03 / A / AA / 0007" />
        </div>
        <div>
          <label>接頭辞</label>
          <input id="prefixSplit" type="text" value="P" />
        </div>
        <div>
          <label>接尾辞</label>
          <input id="suffixSplit" type="text" placeholder="_page など" />
        </div>
        <div>
          <label>出力</label>
          <select id="outTypeSplit">
            <option value="zip">ZIP（推奨）</option>
            <option value="files">個別ファイル</option>
          </select>
        </div>
        <div>
          <label>大/小（英字）</label>
          <select id="caseSplit">
            <option value="upper">大文字</option>
            <option value="lower">小文字</option>
          </select>
        </div>
      </div>
      <div class="chips" id="previewSplit" style="margin-top:10px"></div>
      <div style="margin-top:12px">
        <button id="runSplit" class="btn" disabled>分割して保存</button>
        <progress id="progSplit" value="0" max="100" hidden></progress>
      </div>
    </div>

    <!-- ===== PDF 結合 ===== -->
    <div id="merge" class="panel card">
      <div class="grid">
        <div>
          <label>PDFを複数選択（順序どおりに並べ替え可能）</label>
          <input id="filesMerge" type="file" accept="application/pdf" multiple />
          <div class="muted">ヒント：ファイル名に番号を含めると並べ替えが楽です。</div>
        </div>
        <div>
          <label>出力ファイル名</label>
          <input id="nameMerge" type="text" value="merged.pdf" />
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="runMerge" class="btn" disabled>結合して保存</button>
        <progress id="progMerge" value="0" max="100" hidden></progress>
      </div>
      <div class="muted" id="listMerge" style="margin-top:8px"></div>
    </div>

    <!-- ===== PDF → 画像 ===== -->
    <div id="exportImages" class="panel card">
      <div class="grid">
        <div>
          <label>PDFファイル</label>
          <input id="fileImg" type="file" accept="application/pdf" />
        </div>
        <div>
          <label>画像形式</label>
          <select id="imgFormat">
            <option value="png">PNG</option>
            <option value="jpeg">JPEG</option>
          </select>
        </div>
        <div>
          <label>解像度スケール</label>
          <input id="imgScale" type="number" step="0.1" value="2" />
          <span class="muted">（1=等倍 / 2=高解像）</span>
        </div>
        <div>
          <label>ZIPファイル名</label>
          <input id="imgZipName" type="text" value="pages.zip" />
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="runImg" class="btn" disabled>画像に書き出してZIP保存</button>
        <progress id="progImg" value="0" max="100" hidden></progress>
      </div>
      <div class="muted" id="infoImg" style="margin-top:8px">PDF未選択</div>
    </div>

    <!-- ===== CSV ビューア ===== -->
    <div id="csv" class="panel card">
      <div class="grid">
        <div>
          <label>CSVファイル</label>
          <input id="fileCsv" type="file" accept="text/csv,.csv" />
        </div>
        <div>
          <label>区切り</label>
          <select id="csvDelim">
            <option value=",">カンマ (,)</option>
            <option value="	">タブ (	)</option>
            <option value=";">セミコロン (;)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="muted">ヘッダをクリックでソート。簡易グラフは数値列を選択して作成。</div>
      </div>
      <div style="margin-top:12px" id="csvControls" hidden>
        <label>グラフ列（数値）</label>
        <select id="csvY"></select>
        <label>カテゴリ列</label>
        <select id="csvX"></select>
        <button class="btn" id="csvPlot">グラフ作成</button>
      </div>
      <div style="margin-top:12px; overflow:auto; max-height:360px" id="csvTableWrap"></div>
      <div style="margin-top:16px">
        <canvas id="csvChart"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <details>
        <summary>このサイトについて（プライバシー）</summary>
        <p>すべての処理はブラウザ内で行われ、ファイルは外部サーバに送信されません。</p>
      </details>
    </div>
  </div>

  <!-- ===== Libraries ===== -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- pdf.js (for rasterizing PDF pages) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.min.js"></script>
  <script>
    // ===== Tabs =====
    const tabs = document.getElementById('tabs');
    tabs.addEventListener('click', (e)=>{
      const el = e.target.closest('.tab');
      if(!el) return;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      const tgt = document.querySelector(el.dataset.target);
      if(tgt) tgt.classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // ====== 共通 util ======
    function downloadBlob(blob, filename){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=filename; a.style.display='none';
      document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
    }

    // ====== 分割 ======
    const fileSplit = document.getElementById('fileSplit');
    const runSplit = document.getElementById('runSplit');
    const infoSplit = document.getElementById('infoSplit');
    const modeSplit = document.getElementById('modeSplit');
    const startSplit = document.getElementById('startSplit');
    const prefixSplit = document.getElementById('prefixSplit');
    const suffixSplit = document.getElementById('suffixSplit');
    const outTypeSplit = document.getElementById('outTypeSplit');
    const caseSplit = document.getElementById('caseSplit');
    const previewSplit = document.getElementById('previewSplit');
    const progSplit = document.getElementById('progSplit');

    let splitPages=0;
    fileSplit.addEventListener('change', async ()=>{
      if(!fileSplit.files?.[0]){ runSplit.disabled=true; infoSplit.textContent='PDF未選択'; previewSplit.innerHTML=''; return; }
      const arr = await fileSplit.files[0].arrayBuffer();
      const pdf = await PDFLib.PDFDocument.load(arr);
      splitPages = pdf.getPageCount();
      infoSplit.textContent = `ページ数: ${splitPages}`;
      runSplit.disabled=false;
      updateSplitPreview();
    });
    [modeSplit,startSplit,prefixSplit,suffixSplit,caseSplit].forEach(el=>{
      el.addEventListener('input', updateSplitPreview);
      el.addEventListener('change', updateSplitPreview);
    });
    function updateSplitPreview(){
      previewSplit.innerHTML='';
      const list = nextNames(5, startSplit.value|| (modeSplit.value==='number'?'01':'A'), modeSplit.value, caseSplit.value, prefixSplit.value||'', suffixSplit.value||'');
      for(const n of list){ const s=document.createElement('span'); s.className='chip'; s.textContent=n; previewSplit.appendChild(s); }
    }
    function nextNames(k,start,mode,caseSel,pre,suf){
      let token=start; const out=[];
      for(let i=0;i<k;i++){ out.push(`${pre}${token}${suf}.pdf`); token=incToken(token,mode,caseSel); }
      return out;
    }
    function alphaInc(s, upper=true){
      const base = upper? 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' : 'abcdefghijklmnopqrstuvwxyz';
      let arr = s.split('').map(ch=> base.indexOf(ch.toUpperCase()));
      if(arr.some(x=>x<0)) arr=[0];
      for(let i=arr.length-1;i>=0;i--){ if(arr[i]<25){ arr[i]++; for(let j=i+1;j<arr.length;j++) arr[j]=0; return arr.map(x=>base[x]).join(''); } }
      return base[0] + arr.map(x=>base[x]).join('');
    }
    function incToken(token, mode, caseSel){
      if(mode==='number'){
        const n = parseInt(token,10);
        if(Number.isFinite(n)) return String(n+1).padStart(String(n).length,'0');
        return token;
      }
      if(mode==='alpha') return alphaInc(token, caseSel==='upper');
      const m = token.match(/(.*?)([0-9]+|[A-Za-z]+)$/);
      if(!m) return token+'1';
      const head=m[1], tail=m[2];
      let next;
      if(/^[0-9]+$/.test(tail)) next=String(parseInt(tail,10)+1).padStart(tail.length,'0');
      else next=alphaInc(tail, /[A-Z]/.test(tail[0]));
      return head+next;
    }
    runSplit.addEventListener('click', async ()=>{
      if(!fileSplit.files?.[0]) return;
      runSplit.disabled=true; progSplit.hidden=false; progSplit.value=0; infoSplit.textContent='分割中...';
      const arr = await fileSplit.files[0].arrayBuffer();
      const src = await PDFLib.PDFDocument.load(arr);
      let token = startSplit.value || (modeSplit.value==='number'?'01':'A');
      const pre = prefixSplit.value||''; const suf = suffixSplit.value||'';
      const zip = outTypeSplit.value==='zip'? new JSZip(): null;
      for(let i=0;i<src.getPageCount();i++){
        const out = await PDFLib.PDFDocument.create();
        const [p] = await out.copyPages(src,[i]);
        out.addPage(p);
        const bytes = await out.save();
        const fn = `${pre}${token}${suf}.pdf`;
        if(zip) zip.file(fn, bytes); else downloadBlob(new Blob([bytes],{type:'application/pdf'}), fn);
        token = incToken(token, modeSplit.value, caseSplit.value);
        progSplit.value=Math.round(((i+1)/src.getPageCount())*100);
      }
      if(zip){ const blob = await zip.generateAsync({type:'blob'}); const base=(fileSplit.files[0].name.replace(/\.pdf$/i,'')||'split')+'_pages.zip'; downloadBlob(blob, base); }
      infoSplit.textContent=`完了: ${src.getPageCount()} ファイル`;
      runSplit.disabled=false; progSplit.hidden=true;
    });

    // ====== 結合 ======
    const filesMerge = document.getElementById('filesMerge');
    const runMerge = document.getElementById('runMerge');
    const progMerge = document.getElementById('progMerge');
    const listMerge = document.getElementById('listMerge');
    const nameMerge = document.getElementById('nameMerge');

    let mergeFiles=[];
    filesMerge.addEventListener('change', ()=>{
      mergeFiles = Array.from(filesMerge.files||[]);
      runMerge.disabled = mergeFiles.length===0;
      if(mergeFiles.length){
        // 名前の昇順で並び替え（ユーザーがドラッグ順を変えたい場合は今後UIを検討）
        mergeFiles.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
        listMerge.textContent = '順序: ' + mergeFiles.map(f=>f.name).join(' → ');
      } else listMerge.textContent='';
    });

    runMerge.addEventListener('click', async ()=>{
      if(!mergeFiles.length) return;
      runMerge.disabled=true; progMerge.hidden=false; progMerge.value=0;
      const out = await PDFLib.PDFDocument.create();
      let totalPages=0, processed=0;
      // まず総ページ数
      for(const f of mergeFiles){
        const arr = await f.arrayBuffer(); const pdf = await PDFLib.PDFDocument.load(arr); totalPages += pdf.getPageCount();
      }
      for(const f of mergeFiles){
        const arr = await f.arrayBuffer(); const pdf = await PDFLib.PDFDocument.load(arr);
        const pages = await out.copyPages(pdf, pdf.getPageIndices());
        pages.forEach(p=>out.addPage(p));
        processed += pdf.getPageCount();
        progMerge.value = Math.round((processed/totalPages)*100);
      }
      const bytes = await out.save();
      downloadBlob(new Blob([bytes],{type:'application/pdf'}), nameMerge.value||'merged.pdf');
      runMerge.disabled=false; progMerge.hidden=true;
    });

    // ====== PDF → 画像 ======
    const fileImg = document.getElementById('fileImg');
    const runImg = document.getElementById('runImg');
    const progImg = document.getElementById('progImg');
    const infoImg = document.getElementById('infoImg');
    const imgFormat = document.getElementById('imgFormat');
    const imgScale = document.getElementById('imgScale');
    const imgZipName = document.getElementById('imgZipName');

    fileImg.addEventListener('change', ()=>{
      runImg.disabled = !fileImg.files?.[0];
      infoImg.textContent = fileImg.files?.[0] ? fileImg.files[0].name : 'PDF未選択';
    });

    // pdf.js のワーカー設定（CDN）
    if(window['pdfjsLib']){
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.worker.min.js';
    }

    runImg.addEventListener('click', async ()=>{
      if(!fileImg.files?.[0]) return;
      runImg.disabled=true; progImg.hidden=false; progImg.value=0; infoImg.textContent='レンダリング中...';
      const arr = await fileImg.files[0].arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arr}).promise;
      const zip = new JSZip();
      const fmt = imgFormat.value; const scale = Math.max(0.5, Math.min(4, Number(imgScale.value)||2));
      const total = pdf.numPages;
      for(let i=1;i<=total;i++){
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({scale});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({canvasContext: ctx, viewport}).promise;
        const dataUrl = canvas.toDataURL('image/'+fmt, fmt==='jpeg'?0.92:1.0);
        const bstr = atob(dataUrl.split(',')[1]);
        const u8 = new Uint8Array(bstr.length); for(let j=0;j<bstr.length;j++) u8[j]=bstr.charCodeAt(j);
        zip.file(`${String(i).padStart(String(total).length,'0')}.${fmt}`, u8, {binary:true});
        progImg.value = Math.round((i/total)*100);
      }
      const blob = await zip.generateAsync({type:'blob'});
      downloadBlob(blob, imgZipName.value || 'pages.zip');
      infoImg.textContent = `完了: ${pdf.numPages} ページ`;
      runImg.disabled=false; progImg.hidden=true;
    });

    // ====== CSV ビューア ======
    const fileCsv = document.getElementById('fileCsv');
    const csvDelim = document.getElementById('csvDelim');
    const csvTableWrap = document.getElementById('csvTableWrap');
    const csvControls = document.getElementById('csvControls');
    const csvX = document.getElementById('csvX');
    const csvY = document.getElementById('csvY');
    const csvPlotBtn = document.getElementById('csvPlot');
    const csvChartCanvas = document.getElementById('csvChart');
    let csvData = [];
    let csvChart;

    function renderCsvTable(headers, rows){
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      headers.forEach((h, idx)=>{
        const th=document.createElement('th'); th.textContent=h||`col${idx+1}`; th.dataset.index=idx;
        th.addEventListener('click', ()=>{ rows.sort((a,b)=> String(a[idx]).localeCompare(String(b[idx]), undefined, {numeric:true})); csvTableWrap.innerHTML=''; renderCsvTable(headers, rows); });
        trh.appendChild(th);
      });
      thead.appendChild(trh); table.appendChild(thead);
      const tbody=document.createElement('tbody');
      rows.forEach(r=>{ const tr=document.createElement('tr'); r.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); }); tbody.appendChild(tr); });
      table.appendChild(tbody);
      csvTableWrap.innerHTML=''; csvTableWrap.appendChild(table);
    }

    function populateCsvControls(headers){
      csvX.innerHTML=''; csvY.innerHTML='';
      headers.forEach((h,i)=>{
        const optX=document.createElement('option'); optX.value=i; optX.textContent=h||`col${i+1}`; csvX.appendChild(optX);
        const optY=document.createElement('option'); optY.value=i; optY.textContent=h||`col${i+1}`; csvY.appendChild(optY);
      });
      csvControls.hidden=false;
    }

    fileCsv.addEventListener('change', ()=>{
      const f = fileCsv.files?.[0]; if(!f) return;
      Papa.parse(f, {delimiter: csvDelim.value, complete: (res)=>{
        const rows = res.data.filter(r=> r.some(x=> String(x).trim()!==''));
        const headers = rows.shift() || [];
        csvData = {headers, rows};
        renderCsvTable(headers, rows);
        populateCsvControls(headers);
      }});
    });

    csvDelim.addEventListener('change', ()=>{ if(fileCsv.files?.[0]) fileCsv.dispatchEvent(new Event('change')); });

    csvPlotBtn.addEventListener('click', ()=>{
      if(!csvData.headers) return;
      const xi = Number(csvX.value), yi = Number(csvY.value);
      const labels = csvData.rows.map(r=> String(r[xi]));
      const values = csvData.rows.map(r=> Number(r[yi])).filter(v=> !Number.isNaN(v));
      const cfg = {type:'bar', data:{labels, datasets:[{label: csvData.headers[yi]||'value', data: values}]}, options:{responsive:true, plugins:{legend:{position:'top'}}}};
      if(csvChart) csvChart.destroy();
      csvChart = new Chart(csvChartCanvas, cfg);
    });
  </script>
  <a class="btn" href="math.html" target="_blank" rel="noopener">数式描画（LaTeX）</a>
</body>
</html>
